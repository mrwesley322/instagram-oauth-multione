<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîß Diagn√≥stico Webhook - Erro 400</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #ef4444, #dc2626, #b91c1c);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 2.8rem;
            background: linear-gradient(135deg, #ef4444, #dc2626);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .error-badge {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            display: inline-block;
            margin: 10px 0;
        }

        .main-panel {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            text-align: center;
        }

        .btn {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            font-size: 1.1rem;
            margin: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(239, 68, 68, 0.4);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }

        .btn-info {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
        }

        .diagnostic-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .diagnostic-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border: 2px solid #e5e7eb;
            transition: all 0.3s ease;
        }

        .diagnostic-card:hover {
            transform: translateY(-5px);
            border-color: #ef4444;
        }

        .diagnostic-card.error {
            border-color: #ef4444;
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.05), rgba(255, 255, 255, 1));
        }

        .diagnostic-card.warning {
            border-color: #f59e0b;
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.05), rgba(255, 255, 255, 1));
        }

        .diagnostic-card.info {
            border-color: #3b82f6;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.05), rgba(255, 255, 255, 1));
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .card-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.5rem;
        }

        .error-icon { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .warning-icon { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .info-icon { background: linear-gradient(135deg, #3b82f6, #1d4ed8); }

        .api-test-result {
            background: #1f2937;
            color: #f9fafb;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
            max-height: 200px;
            overflow-y: auto;
        }

        .logs-container {
            background: #1f2937;
            color: #f9fafb;
            border-radius: 10px;
            padding: 20px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            max-height: 400px;
            overflow-y: auto;
            margin: 20px 0;
        }

        .log-entry {
            margin-bottom: 8px;
            padding: 5px 0;
            border-left: 3px solid transparent;
            padding-left: 10px;
        }

        .log-info { color: #60a5fa; border-left-color: #60a5fa; }
        .log-success { color: #34d399; border-left-color: #34d399; }
        .log-warning { color: #fbbf24; border-left-color: #fbbf24; }
        .log-error { color: #f87171; border-left-color: #f87171; }

        .solution-panel {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(255, 255, 255, 1));
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            border-left: 5px solid #10b981;
        }

        @media (max-width: 768px) {
            .diagnostic-grid {
                grid-template-columns: 1fr;
            }
            
            .container {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üîß Diagn√≥stico Webhook</h1>
            <div class="error-badge">‚ùå ERRO 400 - BAD REQUEST</div>
            <p>Diagnosticando problemas na configura√ß√£o de webhooks</p>
        </div>

        <!-- Painel Principal -->
        <div class="main-panel">
            <h2 style="margin-bottom: 20px;">ü©∫ Diagn√≥stico Completo do Erro 400</h2>
            <p style="margin-bottom: 30px; color: #666;">
                Token funcionando mas webhook falhando. Vamos identificar exatamente o que est√° causando o erro 400.
            </p>
            
            <button class="btn" onclick="startWebhookDiagnostic()">
                üîç Diagn√≥stico Completo
            </button>
            
            <button class="btn btn-warning" onclick="testTokenType()">
                üè∑Ô∏è Verificar Tipo de Token
            </button>
            
            <button class="btn btn-info" onclick="testWebhookEndpoints()">
                üì° Testar Endpoints
            </button>
        </div>

        <!-- Diagn√≥sticos -->
        <div class="diagnostic-grid" id="diagnostic-grid">
            <!-- Cards de diagn√≥stico aparecer√£o aqui -->
        </div>

        <!-- Painel de Solu√ß√µes -->
        <div class="solution-panel" id="solution-panel" style="display: none;">
            <h3>üí° Solu√ß√µes Identificadas</h3>
            <div id="solutions-content">
                <!-- Solu√ß√µes aparecer√£o aqui -->
            </div>
        </div>

        <!-- Logs do Sistema -->
        <div class="logs-container" id="logs-container">
            <div class="log-entry log-success">
                <span>[TOKENS]</span> Tokens atualizados carregados - ivangeli: IGAAR3ZBf0HH... | wesley: ID 17841464566186399
            </div>
            <div class="log-entry log-info">
                <span>[SISTEMA]</span> Diagn√≥stico carregado com tokens NOVOS - Pronto para testar webhook!
            </div>
        </div>
    </div>

    <script>
        // Tokens COMPLETOS atualizados para teste
        const TEST_TOKENS = {
            ivangeli: {
                token: 'IGAAR3ZBf0HHjxBZAE8wSVJ5eGZA5c3dRN21IaDF2ZAzdudTVRckpsSnVzeE1aVThFUmxhSzREMG5hemJacnpMbDUwNEIwTmY0bW1MZAGNkYU9NSnA1aHpIRjhaT3VHQWM3MGx5TmtqaUZAwdnpJejVTRXpRYjhyTm1oR2tabURGOUZAfdwZDZD',
                pageId: '529883964211992',
                username: 'ivangeli_'
            },
            wesley: {
                token: 'IGAAR3ZBf0HHjxBZAFA0YVhXN1FlS1d2ak1OZA2lXMmJwU2ZAia2czellGVHV3OGpXVVM0TGIwSDlZAWHU3RElpdHRNTnZAQZAnR4QTdzU2NQdUZAibmR0c3JKNFZAyMUhoOExfcjNmWDgySDR0dXRjS3hmMUpSWUw5OEdLVkhfOFFWb3ZACdwZDZD', // Token COMPLETO do wesley
                pageId: '255538924943656', 
                username: 'wesley_costa322'
            }
        };
        
        // Token principal para teste (come√ßar com wesley que tem token completo)
        const TEST_TOKEN = TEST_TOKENS.wesley.token;
        const PAGE_ID = TEST_TOKENS.wesley.pageId;
        
        let diagnosticResults = [];

        // Iniciar diagn√≥stico completo
        async function startWebhookDiagnostic() {
            addLog('info', 'üîç Iniciando diagn√≥stico completo com TOKENS COMPLETOS...');
            addLog('success', `üîë Wesley: ${TEST_TOKENS.wesley.token.substring(0, 20)}... (COMPLETO)`);
            addLog('success', `üîë Ivangeli: ${TEST_TOKENS.ivangeli.token.substring(0, 20)}... (COMPLETO)`);
            addLog('info', `üìÑ Testando primeiro: wesley_costa322 (Page: ${TEST_TOKENS.wesley.pageId})`);
            
            const diagnosticGrid = document.getElementById('diagnostic-grid');
            diagnosticGrid.innerHTML = '';
            diagnosticResults = [];
            
            // Teste 1: Verificar tipo de token (wesley primeiro)
            await diagnosticTokenType();
            
            // Teste 2: Testar ambos os tokens com webhook REAL
            await diagnosticBothTokens();
            
            // Teste 3: Testar diferentes endpoints
            await diagnosticWebhookEndpoints();
            
            // Teste 4: Verificar permiss√µes
            await diagnosticPermissions();
            
            // Teste 5: Testar estrutura da requisi√ß√£o
            await diagnosticRequestStructure();
            
            // Mostrar solu√ß√µes
            showSolutions();
            
            addLog('success', '‚úÖ Diagn√≥stico completo finalizado com TOKENS COMPLETOS!');
        }

        // Diagn√≥stico: Tipo de Token (Foco no Wesley)
        async function diagnosticTokenType() {
            addLog('info', 'üè∑Ô∏è Verificando tipo do token do wesley_costa322 (token completo)...');
            
            const card = createDiagnosticCard('info', 'üè∑Ô∏è', 'Token Wesley (Completo)', 'Verificando token completo do wesley...');
            
            try {
                // Testar como Instagram token
                const igResponse = await fetch(`https://graph.facebook.com/v18.0/me?access_token=${TEST_TOKEN}`);
                const igData = await igResponse.json();
                
                // Testar informa√ß√µes da p√°gina
                const pageResponse = await fetch(`https://graph.facebook.com/v18.0/${PAGE_ID}?access_token=${TEST_TOKEN}`);
                const pageData = await pageResponse.json();
                
                // Testar debug do token
                const debugResponse = await fetch(`https://graph.facebook.com/debug_token?input_token=${TEST_TOKEN}&access_token=${TEST_TOKEN}`);
                const debugData = await debugResponse.json();
                
                let result = {
                    type: 'token_type',
                    instagramWorking: !igData.error,
                    pageWorking: !pageData.error,
                    instagramData: igData,
                    pageData: pageData,
                    debugData: debugData
                };
                
                // Atualizar card com resultados
                let content = '<div class="api-test-result">';
                content += '<strong>TOKEN WESLEY (COMPLETO):</strong><br>';
                content += `üîç Preview: ${TEST_TOKEN.substring(0, 30)}...<br>`;
                content += `üìè Tamanho: ${TEST_TOKEN.length} caracteres<br><br>`;
                
                if (result.instagramWorking) {
                    content += `‚úÖ Instagram/Me: ID ${igData.id}<br>`;
                    content += `üë§ Nome: ${igData.name || 'N/A'}<br>`;
                    content += `üìß Username: ${igData.username || 'N/A'}<br>`;
                } else {
                    content += `‚ùå Instagram/Me: ${igData.error?.message}<br>`;
                    content += `üîç C√≥digo: ${igData.error?.code}<br>`;
                }
                
                if (result.pageWorking) {
                    content += `‚úÖ Page Access: ${pageData.name || 'Dados obtidos'}<br>`;
                } else {
                    content += `‚ùå Page Access: ${pageData.error?.message}<br>`;
                }
                
                if (debugData.data) {
                    content += `<br>üîç Debug Info:<br>`;
                    content += `App ID: ${debugData.data.app_id}<br>`;
                    content += `V√°lido: ${debugData.data.is_valid ? 'Sim' : 'N√£o'}<br>`;
                    if (debugData.data.expires_at) {
                        content += `Expira: ${new Date(debugData.data.expires_at * 1000).toLocaleString()}<br>`;
                    }
                    if (debugData.data.scopes) {
                        content += `Scopes: ${debugData.data.scopes.join(', ')}<br>`;
                    }
                } else if (debugData.error) {
                    content += `<br>‚ùå Debug: ${debugData.error.message}<br>`;
                }
                
                content += '</div>';
                
                updateDiagnosticCard(card, result.instagramWorking ? 'info' : 'error', 
                    result.instagramWorking ? 'Token wesley funcionando perfeitamente' : 'Problema com token wesley', content);
                
                diagnosticResults.push(result);
                addLog(result.instagramWorking ? 'success' : 'error', 
                    `Token wesley: ${result.instagramWorking ? 'FUNCIONANDO!' : 'Problema identificado'}`);
                
            } catch (error) {
                updateDiagnosticCard(card, 'error', 'Erro na verifica√ß√£o', `<div class="api-test-result">Erro: ${error.message}</div>`);
                addLog('error', `Erro verificando token wesley: ${error.message}`);
            }
        }

        // Diagn√≥stico: Endpoints de Webhook
        async function diagnosticWebhookEndpoints() {
            addLog('info', 'üì° Testando endpoints de webhook...');
            
            const card = createDiagnosticCard('warning', 'üì°', 'Endpoints Webhook', 'Testando diferentes endpoints...');
            
            const endpoints = [
                { name: 'subscribed_apps', url: `https://graph.facebook.com/v18.0/${PAGE_ID}/subscribed_apps` },
                { name: 'subscriptions', url: `https://graph.facebook.com/v18.0/${PAGE_ID}/subscriptions` },
                { name: 'page_info', url: `https://graph.facebook.com/v18.0/${PAGE_ID}?fields=subscribed_apps` }
            ];
            
            let results = {};
            let content = '<div class="api-test-result">';
            
            for (const endpoint of endpoints) {
                try {
                    const response = await fetch(`${endpoint.url}?access_token=${TEST_TOKEN}`, {
                        method: 'GET'
                    });
                    const data = await response.json();
                    
                    results[endpoint.name] = {
                        status: response.status,
                        success: response.ok,
                        data: data
                    };
                    
                    content += `${response.ok ? '‚úÖ' : '‚ùå'} ${endpoint.name}: ${response.status}<br>`;
                    if (data.error) {
                        content += `   Erro: ${data.error.message}<br>`;
                    }
                    
                } catch (error) {
                    results[endpoint.name] = {
                        success: false,
                        error: error.message
                    };
                    content += `‚ùå ${endpoint.name}: ${error.message}<br>`;
                }
            }
            content += '</div>';
            
            const hasSuccess = Object.values(results).some(r => r.success);
            updateDiagnosticCard(card, hasSuccess ? 'info' : 'error', 
                hasSuccess ? 'Alguns endpoints funcionando' : 'Todos endpoints falhando', content);
            
            diagnosticResults.push({ type: 'endpoints', results: results });
        }

        // Diagn√≥stico: Permiss√µes
        async function diagnosticPermissions() {
            addLog('info', 'üîê Verificando permiss√µes do token...');
            
            const card = createDiagnosticCard('warning', 'üîê', 'Permiss√µes', 'Verificando permiss√µes dispon√≠veis...');
            
            try {
                const response = await fetch(`https://graph.facebook.com/v18.0/me/permissions?access_token=${TEST_TOKEN}`);
                const data = await response.json();
                
                let content = '<div class="api-test-result">';
                if (data.data) {
                    const requiredPerms = ['pages_messaging', 'pages_manage_posts', 'instagram_manage_messages'];
                    
                    content += 'Permiss√µes encontradas:<br>';
                    data.data.forEach(perm => {
                        const isRequired = requiredPerms.includes(perm.permission);
                        const icon = perm.status === 'granted' ? '‚úÖ' : '‚ùå';
                        const important = isRequired ? ' (NECESS√ÅRIA)' : '';
                        content += `${icon} ${perm.permission}: ${perm.status}${important}<br>`;
                    });
                    
                    const missingPerms = requiredPerms.filter(req => 
                        !data.data.some(perm => perm.permission === req && perm.status === 'granted')
                    );
                    
                    if (missingPerms.length > 0) {
                        content += '<br>‚ùå PERMISS√ïES FALTANDO:<br>';
                        missingPerms.forEach(perm => {
                            content += `   ‚Ä¢ ${perm}<br>`;
                        });
                    }
                } else {
                    content += `Erro: ${data.error?.message || 'N√£o foi poss√≠vel obter permiss√µes'}`;
                }
                content += '</div>';
                
                const hasRequired = data.data && data.data.some(p => 
                    p.permission === 'pages_messaging' && p.status === 'granted'
                );
                
                updateDiagnosticCard(card, hasRequired ? 'info' : 'error',
                    hasRequired ? 'Permiss√µes b√°sicas OK' : 'Permiss√µes insuficientes', content);
                
                diagnosticResults.push({ type: 'permissions', data: data });
                
            } catch (error) {
                updateDiagnosticCard(card, 'error', 'Erro verificando permiss√µes', 
                    `<div class="api-test-result">Erro: ${error.message}</div>`);
                addLog('error', `Erro verificando permiss√µes: ${error.message}`);
            }
        }

        // Diagn√≥stico: Estrutura da Requisi√ß√£o
        async function diagnosticRequestStructure() {
            addLog('info', 'üîß Testando estrutura da requisi√ß√£o webhook...');
            
            const card = createDiagnosticCard('info', 'üîß', 'Estrutura da Requisi√ß√£o', 'Testando diferentes formatos...');
            
            const testRequests = [
                {
                    name: 'POST subscribed_apps',
                    method: 'POST',
                    url: `https://graph.facebook.com/v18.0/${PAGE_ID}/subscribed_apps`,
                    body: { subscribed_fields: 'messages' }
                },
                {
                    name: 'POST subscriptions',
                    method: 'POST', 
                    url: `https://graph.facebook.com/v18.0/${PAGE_ID}/subscriptions`,
                    body: { object: 'page', callback_url: 'https://example.com/webhook', fields: ['messages'] }
                }
            ];
            
            let content = '<div class="api-test-result">';
            
            for (const testReq of testRequests) {
                try {
                    const formData = new FormData();
                    Object.keys(testReq.body).forEach(key => {
                        formData.append(key, typeof testReq.body[key] === 'object' ? 
                            JSON.stringify(testReq.body[key]) : testReq.body[key]);
                    });
                    formData.append('access_token', TEST_TOKEN);
                    
                    const response = await fetch(testReq.url, {
                        method: testReq.method,
                        body: formData
                    });
                    
                    const data = await response.json();
                    
                    content += `${response.ok ? '‚úÖ' : '‚ùå'} ${testReq.name}: ${response.status}<br>`;
                    if (data.error) {
                        content += `   Erro: ${data.error.message} (C√≥digo: ${data.error.code})<br>`;
                        content += `   Tipo: ${data.error.type}<br>`;
                    }
                    if (response.ok) {
                        content += `   Sucesso: ${JSON.stringify(data)}<br>`;
                    }
                    content += '<br>';
                    
                } catch (error) {
                    content += `‚ùå ${testReq.name}: ${error.message}<br><br>`;
                }
            }
            content += '</div>';
            
            updateDiagnosticCard(card, 'info', 'Teste de requisi√ß√µes conclu√≠do', content);
        }

        // Criar card de diagn√≥stico
        function createDiagnosticCard(type, icon, title, description) {
            const diagnosticGrid = document.getElementById('diagnostic-grid');
            
            const card = document.createElement('div');
            card.className = `diagnostic-card ${type}`;
            card.innerHTML = `
                <div class="card-header">
                    <div class="card-icon ${type}-icon">${icon}</div>
                    <div>
                        <h3 style="margin: 0; color: #333;">${title}</h3>
                        <p style="margin: 5px 0 0 0; color: #666; font-size: 0.9rem;" class="card-description">${description}</p>
                    </div>
                </div>
                <div class="card-content">
                    <!-- Conte√∫do ser√° preenchido -->
                </div>
            `;
            
            diagnosticGrid.appendChild(card);
            return card;
        }

        // Atualizar card de diagn√≥stico
        function updateDiagnosticCard(card, newType, newDescription, content) {
            card.className = `diagnostic-card ${newType}`;
            card.querySelector('.card-description').textContent = newDescription;
            card.querySelector('.card-content').innerHTML = content;
        }

        // Mostrar solu√ß√µes
        function showSolutions() {
            const solutionPanel = document.getElementById('solution-panel');
            const solutionsContent = document.getElementById('solutions-content');
            
            let solutions = [];
            
            // Analisar resultados e sugerir solu√ß√µes
            const tokenResult = diagnosticResults.find(r => r.type === 'token_type');
            const permissionsResult = diagnosticResults.find(r => r.type === 'permissions');
            
            if (tokenResult && !tokenResult.instagramWorking) {
                solutions.push({
                    title: 'üîë Problema com Token',
                    description: 'O token n√£o est√° funcionando corretamente para Instagram.',
                    action: 'Gere um novo token no Graph API Explorer com as permiss√µes corretas.'
                });
            }
            
            if (permissionsResult && permissionsResult.data.data) {
                const hasMessagingPerm = permissionsResult.data.data.some(p => 
                    p.permission === 'pages_messaging' && p.status === 'granted'
                );
                if (!hasMessagingPerm) {
                    solutions.push({
                        title: 'üîê Permiss√µes Insuficientes',
                        description: 'Token n√£o tem permiss√£o pages_messaging necess√°ria para webhooks.',
                        action: 'Regenere o token incluindo a permiss√£o pages_messaging.'
                    });
                }
            }
            
            // Solu√ß√£o geral para erro 400
            solutions.push({
                title: 'üîß Erro 400 - Bad Request',
                description: 'A requisi√ß√£o est√° malformada ou usando endpoint incorreto.',
                action: 'Use o endpoint correto: /{page-id}/subscribed_apps com m√©todo POST e campo subscribed_fields.'
            });
            
            if (solutions.length > 0) {
                let content = '';
                solutions.forEach((solution, index) => {
                    content += `
                        <div style="margin-bottom: 20px; padding: 15px; background: rgba(16, 185, 129, 0.1); border-radius: 8px;">
                            <h4 style="color: #10b981; margin-bottom: 10px;">${solution.title}</h4>
                            <p style="margin-bottom: 10px;"><strong>Problema:</strong> ${solution.description}</p>
                            <p><strong>Solu√ß√£o:</strong> ${solution.action}</p>
                        </div>
                    `;
                });
                
                solutionsContent.innerHTML = content;
                solutionPanel.style.display = 'block';
            }
        }

        // Testar tipo de token individualmente
        async function testTokenType() {
            await diagnosticTokenType();
        }

        // Testar endpoints individualmente
        async function testWebhookEndpoints() {
            await diagnosticWebhookEndpoints();
        }

        // Adicionar log
        function addLog(level, message) {
            const logsContainer = document.getElementById('logs-container');
            const timestamp = new Date().toLocaleTimeString();
            
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${level}`;
            logEntry.innerHTML = `<span>[${timestamp}]</span> ${message}`;
            
            logsContainer.insertBefore(logEntry, logsContainer.firstChild);
            
            // Manter apenas 50 logs
            while (logsContainer.children.length > 50) {
                logsContainer.removeChild(logsContainer.lastChild);
            }
        }

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            addLog('error', '‚ùå Webhook retornando erro 400 - Bad Request');
            addLog('info', 'üîç Sistema de diagn√≥stico carregado');
            addLog('warning', 'üí° Clique em "Diagn√≥stico Completo" para identificar o problema');
        });
    </script>
</body>
</html>
