<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß™ Instagram Message Flow Tester</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #8b5cf6, #7c3aed, #6d28d9);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 25px;
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
            border-radius: 15px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .test-flow {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 30px;
            margin: 30px 0;
        }

        .control-panel {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border-left: 5px solid #8b5cf6;
            height: fit-content;
        }

        .message-tester {
            background: #f8fafc;
            border: 2px solid #8b5cf6;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
        }

        .btn {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin: 10px 0;
            font-size: 1rem;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(139, 92, 246, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }

        .input-group {
            margin: 15px 0;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
        }

        .input-group input, .input-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
        }

        .input-group input:focus, .input-group textarea:focus {
            outline: none;
            border-color: #8b5cf6;
        }

        .flow-monitor {
            background: #1f2937;
            color: white;
            border-radius: 15px;
            padding: 25px;
            min-height: 600px;
        }

        .flow-steps {
            display: grid;
            gap: 15px;
            margin-bottom: 20px;
        }

        .flow-step {
            background: #374151;
            padding: 15px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .flow-step.active {
            background: #7c3aed;
            animation: pulse 2s infinite;
        }

        .flow-step.success {
            background: #059669;
        }

        .flow-step.error {
            background: #dc2626;
        }

        .step-number {
            background: #6b7280;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .flow-step.active .step-number {
            background: white;
            color: #7c3aed;
        }

        .flow-step.success .step-number {
            background: white;
            color: #059669;
        }

        .flow-step.error .step-number {
            background: white;
            color: #dc2626;
        }

        .monitor-logs {
            background: #111827;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
        }

        .log-entry {
            margin-bottom: 8px;
            padding: 8px;
            border-radius: 4px;
            word-break: break-all;
        }

        .log-error { background: rgba(248, 113, 113, 0.2); color: #fca5a5; }
        .log-success { background: rgba(52, 211, 153, 0.2); color: #6ee7b7; }
        .log-info { background: rgba(96, 165, 250, 0.2); color: #93c5fd; }
        .log-webhook { background: rgba(167, 139, 250, 0.2); color: #c4b5fd; }
        .log-instagram { background: rgba(236, 72, 153, 0.2); color: #f9a8d4; }

        .accounts-info {
            background: #ecfdf5;
            border: 2px solid #10b981;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .test-history {
            background: #fef3c7;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            max-height: 200px;
            overflow-y: auto;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .countdown {
            font-size: 2rem;
            font-weight: bold;
            text-align: center;
            margin: 20px 0;
            color: #8b5cf6;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üß™ Instagram Message Flow Tester</h1>
            <p>Teste completo do fluxo: ivangeli_ ‚Üí wesley_costa322 ‚Üí Sistema ‚Üí MultiOne</p>
        </div>

        <!-- Test Flow Layout -->
        <div class="test-flow">
            <!-- Control Panel -->
            <div class="control-panel">
                <h3 style="color: #8b5cf6; margin-bottom: 20px;">üéõÔ∏è Painel de Controle</h3>

                <!-- Accounts Info -->
                <div class="accounts-info">
                    <h4 style="color: #10b981; margin-bottom: 10px;">üì± Contas de Teste</h4>
                    <p><strong>Remetente:</strong> ivangeli_</p>
                    <p><strong>Destinat√°rio:</strong> wesley_costa322</p>
                    <p><strong>Status:</strong> <span id="tester-status">‚úÖ Testers configurados</span></p>
                </div>

                <!-- Message Tester -->
                <div class="message-tester">
                    <h4 style="color: #8b5cf6; margin-bottom: 15px;">üí¨ Configurar Teste</h4>
                    
                    <div class="input-group">
                        <label>üìù Mensagem de Teste:</label>
                        <textarea id="test-message" rows="3" placeholder="Digite a mensagem que ser√° enviada...">TESTE FLUXO COMPLETO - ivangeli para wesley</textarea>
                    </div>

                    <div class="input-group">
                        <label>‚è±Ô∏è Timeout para resposta (segundos):</label>
                        <input type="number" id="timeout" value="30" min="10" max="120">
                    </div>

                    <button class="btn btn-success" onclick="startFlowTest()">
                        üöÄ INICIAR TESTE COMPLETO
                    </button>

                    <button class="btn btn-warning" onclick="simulateWebhook()">
                        üéØ SIMULAR WEBHOOK (TESTE INTERNO)
                    </button>

                    <button class="btn btn-danger" onclick="resetTest()">
                        üîÑ RESETAR TESTE
                    </button>
                </div>

                <!-- Test History -->
                <div class="test-history">
                    <h4 style="color: #f59e0b; margin-bottom: 10px;">üìä Hist√≥rico de Testes</h4>
                    <div id="test-history">
                        <p style="color: #6b7280; font-style: italic;">Nenhum teste executado ainda...</p>
                    </div>
                </div>
            </div>

            <!-- Flow Monitor -->
            <div class="flow-monitor">
                <h3 style="margin-bottom: 20px;">üìä Monitor do Fluxo de Mensagem</h3>

                <!-- Flow Steps -->
                <div class="flow-steps" id="flow-steps">
                    <div class="flow-step" id="step-1">
                        <div class="step-number">1</div>
                        <div>
                            <strong>üì± Mensagem Instagram</strong>
                            <br><small>Envio de ivangeli_ para wesley_costa322</small>
                        </div>
                    </div>

                    <div class="flow-step" id="step-2">
                        <div class="step-number">2</div>
                        <div>
                            <strong>üì° Webhook Instagram</strong>
                            <br><small>Instagram envia webhook para nosso sistema</small>
                        </div>
                    </div>

                    <div class="flow-step" id="step-3">
                        <div class="step-number">3</div>
                        <div>
                            <strong>üîç Processamento Sistema</strong>
                            <br><small>Sistema processa e valida a mensagem</small>
                        </div>
                    </div>

                    <div class="flow-step" id="step-4">
                        <div class="step-number">4</div>
                        <div>
                            <strong>üöÄ Envio MultiOne</strong>
                            <br><small>Sistema envia mensagem para MultiOne</small>
                        </div>
                    </div>

                    <div class="flow-step" id="step-5">
                        <div class="step-number">5</div>
                        <div>
                            <strong>‚úÖ Confirma√ß√£o</strong>
                            <br><small>MultiOne confirma recebimento</small>
                        </div>
                    </div>
                </div>

                <!-- Countdown -->
                <div class="countdown" id="countdown" style="display: none;">
                    Aguardando resposta: <span id="countdown-timer">30</span>s
                </div>

                <!-- Live Logs -->
                <h4 style="margin: 20px 0 10px 0;">üìã Logs em Tempo Real</h4>
                <div class="monitor-logs" id="live-logs">
                    <div class="log-entry log-info">[SISTEMA] Aguardando in√≠cio do teste...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const BACKEND_URL = 'https://instagram-oauth-multione-production.up.railway.app';
        let testInterval = null;
        let countdownInterval = null;
        let currentTest = null;

        // Iniciar teste completo
        async function startFlowTest() {
            const message = document.getElementById('test-message').value;
            const timeout = parseInt(document.getElementById('timeout').value);

            if (!message.trim()) {
                alert('Por favor, digite uma mensagem de teste!');
                return;
            }

            // Reset do estado
            resetFlowSteps();
            clearLogs();
            
            currentTest = {
                message: message,
                timeout: timeout,
                startTime: new Date(),
                steps: {}
            };

            addLog('info', `üöÄ INICIANDO TESTE COMPLETO`);
            addLog('info', `üìù Mensagem: "${message}"`);
            addLog('info', `‚è±Ô∏è Timeout: ${timeout}s`);

            // Ativar step 1
            setStepActive('step-1');
            addLog('instagram', 'üì± STEP 1: Aguardando envio da mensagem pelo Instagram');

            // Mostrar instru√ß√µes
            addLog('info', 'üìã INSTRU√á√ïES:');
            addLog('info', '1. Abra Instagram na conta: ivangeli_');
            addLog('info', '2. Envie DM para: wesley_costa322');
            addLog('info', `3. Texto exato: "${message}"`);
            addLog('info', '4. Aguarde o processamento...');

            // Iniciar monitoramento
            startTestMonitoring(timeout);
        }

        // Iniciar monitoramento do teste
        function startTestMonitoring(timeout) {
            let timeLeft = timeout;
            
            // Mostrar countdown
            const countdownDiv = document.getElementById('countdown');
            const timerSpan = document.getElementById('countdown-timer');
            countdownDiv.style.display = 'block';

            // Countdown timer
            countdownInterval = setInterval(() => {
                timerSpan.textContent = timeLeft;
                timeLeft--;

                if (timeLeft < 0) {
                    clearInterval(countdownInterval);
                    countdownDiv.style.display = 'none';
                    testTimeout();
                }
            }, 1000);

            // Monitor logs
            testInterval = setInterval(async () => {
                try {
                    await checkForWebhookActivity();
                } catch (error) {
                    addLog('error', `Erro no monitoramento: ${error.message}`);
                }
            }, 2000);
        }

        // Verificar atividade de webhook
        async function checkForWebhookActivity() {
            try {
                const response = await fetch(`${BACKEND_URL}/api/logs`);
                const data = await response.json();

                if (data.logs && data.logs.length > 0) {
                    const recentLogs = data.logs.slice(0, 10);
                    
                    for (const log of recentLogs) {
                        const logTime = new Date(log.timestamp);
                        
                        // Se o log √© depois do in√≠cio do teste
                        if (currentTest && logTime > currentTest.startTime) {
                            processLogForTest(log);
                        }
                    }
                }
            } catch (error) {
                addLog('error', `Erro ao verificar logs: ${error.message}`);
            }
        }

        // Processar log para o teste
        function processLogForTest(log) {
            const message = log.message;

            // Step 2: Webhook recebido
            if (message.includes('Webhook Instagram recebido') && !currentTest.steps.webhook) {
                currentTest.steps.webhook = true;
                setStepSuccess('step-1');
                setStepActive('step-2');
                addLog('webhook', 'üì° STEP 2: Webhook Instagram recebido!');
                addLog('success', '‚úÖ Instagram enviou o webhook - FUNCIONANDO!');
            }

            // Step 3: Processamento
            if (message.includes('Mensagem Instagram recebida') && !currentTest.steps.processing) {
                currentTest.steps.processing = true;
                setStepSuccess('step-2');
                setStepActive('step-3');
                addLog('success', 'üîç STEP 3: Sistema processando mensagem');
                
                // Extrair texto da mensagem se poss√≠vel
                const textMatch = message.match(/"([^"]+)"/);
                if (textMatch) {
                    addLog('info', `üìù Texto capturado: "${textMatch[1]}"`);
                }
            }

            // Step 4: Enviando para MultiOne
            if (message.includes('Enviando para MultiOne') && !currentTest.steps.sending) {
                currentTest.steps.sending = true;
                setStepSuccess('step-3');
                setStepActive('step-4');
                addLog('info', 'üöÄ STEP 4: Enviando para MultiOne...');
            }

            // Step 5: Sucesso completo
            if (message.includes('Mensagem enviada para MultiOne') && !currentTest.steps.complete) {
                currentTest.steps.complete = true;
                setStepSuccess('step-4');
                setStepSuccess('step-5');
                addLog('success', '‚úÖ STEP 5: TESTE COMPLETO - SUCESSO TOTAL!');
                
                completeTest('success');
            }

            // Erros
            if (message.includes('Erro') && message.includes('MultiOne')) {
                setStepError('step-4');
                addLog('error', '‚ùå ERRO: Falha ao enviar para MultiOne');
                completeTest('error_multione');
            }
        }

        // Completar teste
        function completeTest(result) {
            if (testInterval) clearInterval(testInterval);
            if (countdownInterval) clearInterval(countdownInterval);
            
            const countdownDiv = document.getElementById('countdown');
            countdownDiv.style.display = 'none';

            const endTime = new Date();
            const duration = Math.round((endTime - currentTest.startTime) / 1000);

            // Adicionar ao hist√≥rico
            addToTestHistory(result, duration);

            // Log final
            switch (result) {
                case 'success':
                    addLog('success', `üéâ TESTE CONCLU√çDO COM SUCESSO em ${duration}s!`);
                    addLog('success', '‚úÖ Todo o fluxo funcionou perfeitamente!');
                    break;
                case 'timeout':
                    addLog('error', `‚è∞ TESTE TIMEOUT ap√≥s ${duration}s`);
                    addLog('error', '‚ùå Instagram n√£o enviou webhook - problema identificado!');
                    break;
                case 'error_multione':
                    addLog('error', `‚ùå ERRO no MultiOne ap√≥s ${duration}s`);
                    addLog('info', 'üí° Sistema recebe webhooks mas falha no MultiOne');
                    break;
            }

            currentTest = null;
        }

        // Timeout do teste
        function testTimeout() {
            if (!currentTest.steps.webhook) {
                setStepError('step-1');
                setStepError('step-2');
                addLog('error', '‚ùå TIMEOUT: Instagram n√£o enviou webhook');
                addLog('error', 'üí° Poss√≠veis causas:');
                addLog('error', '  - Testers n√£o funcionando corretamente');
                addLog('error', '  - App Review necess√°rio');
                addLog('error', '  - Mensagem n√£o foi enviada via DM');
            }
            
            completeTest('timeout');
        }

        // Simular webhook para teste interno
        async function simulateWebhook() {
            addLog('info', 'üéØ Simulando webhook interno...');
            resetFlowSteps();

            try {
                const testMessage = document.getElementById('test-message').value || 'TESTE SIMULADO INTERNO';
                
                const webhookData = {
                    object: 'instagram',
                    entry: [{
                        id: '752860274568592',
                        messaging: [{
                            sender: { id: 'simulated_ivangeli' },
                            recipient: { id: '752860274568592' },
                            timestamp: Date.now(),
                            message: {
                                mid: 'sim_' + Date.now(),
                                text: testMessage
                            }
                        }]
                    }]
                };

                // Simular os steps
                setStepSuccess('step-1');
                setStepActive('step-2');
                addLog('webhook', 'üì° Enviando webhook simulado...');

                const response = await fetch(`${BACKEND_URL}/webhook/instagram`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(webhookData)
                });

                if (response.ok) {
                    setStepSuccess('step-2');
                    addLog('success', '‚úÖ Webhook simulado processado com sucesso!');
                    addLog('info', 'üí° Sistema interno funcionando - problema √© no Instagram n√£o enviar webhooks reais');
                } else {
                    setStepError('step-2');
                    addLog('error', `‚ùå Erro no webhook simulado: ${response.status}`);
                }

            } catch (error) {
                addLog('error', `‚ùå Erro na simula√ß√£o: ${error.message}`);
                setStepError('step-2');
            }
        }

        // Resetar teste
        function resetTest() {
            if (testInterval) clearInterval(testInterval);
            if (countdownInterval) clearInterval(countdownInterval);
            
            document.getElementById('countdown').style.display = 'none';
            resetFlowSteps();
            clearLogs();
            currentTest = null;
            
            addLog('info', '[SISTEMA] Teste resetado - pronto para novo teste');
        }

        // Gerenciar steps do fluxo
        function resetFlowSteps() {
            for (let i = 1; i <= 5; i++) {
                const step = document.getElementById(`step-${i}`);
                step.className = 'flow-step';
            }
        }

        function setStepActive(stepId) {
            const step = document.getElementById(stepId);
            step.className = 'flow-step active';
        }

        function setStepSuccess(stepId) {
            const step = document.getElementById(stepId);
            step.className = 'flow-step success';
        }

        function setStepError(stepId) {
            const step = document.getElementById(stepId);
            step.className = 'flow-step error';
        }

        // Gerenciar logs
        function addLog(type, message) {
            const logs = document.getElementById('live-logs');
            const timestamp = new Date().toLocaleTimeString();
            
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
            
            logs.insertBefore(logEntry, logs.firstChild);
            
            while (logs.children.length > 50) {
                logs.removeChild(logs.lastChild);
            }
        }

        function clearLogs() {
            const logs = document.getElementById('live-logs');
            logs.innerHTML = '<div class="log-entry log-info">[SISTEMA] Logs limpos - pronto para teste...</div>';
        }

        // Hist√≥rico de testes
        function addToTestHistory(result, duration) {
            const history = document.getElementById('test-history');
            const timestamp = new Date().toLocaleString();
            
            const resultEmoji = {
                'success': '‚úÖ',
                'timeout': '‚è∞',
                'error_multione': '‚ùå'
            }[result] || '‚ùì';

            const resultText = {
                'success': 'Sucesso',
                'timeout': 'Timeout',
                'error_multione': 'Erro MultiOne'
            }[result] || 'Desconhecido';

            if (history.innerHTML.includes('Nenhum teste executado')) {
                history.innerHTML = '';
            }

            const testEntry = document.createElement('div');
            testEntry.style.cssText = 'margin: 5px 0; padding: 8px; background: white; border-radius: 5px; font-size: 0.9rem;';
            testEntry.innerHTML = `${resultEmoji} <strong>${resultText}</strong> - ${duration}s<br><small>${timestamp}</small>`;
            
            history.insertBefore(testEntry, history.firstChild);
            
            while (history.children.length > 10) {
                history.removeChild(history.lastChild);
            }
        }

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            addLog('info', 'üß™ Sistema de teste carregado');
            addLog('info', 'üì± Contas configuradas: ivangeli_ ‚Üí wesley_costa322');
            addLog('info', 'üéØ Pronto para testar o fluxo completo');
        });
    </script>
</body>
</html>
