<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéØ Teste Final - Token com Permiss√µes</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #10b981, #059669, #047857);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            background: linear-gradient(135deg, #10b981, #059669);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .success-badge {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            display: inline-block;
            margin: 5px;
        }

        .final-test {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(255, 255, 255, 1));
            border: 2px solid #10b981;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            text-align: center;
        }

        .btn {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            font-size: 1.2rem;
            margin: 15px;
            min-width: 250px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(16, 185, 129, 0.4);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }

        .btn-primary {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
        }

        .result-box {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            border-left: 4px solid #10b981;
            max-height: 400px;
            overflow-y: auto;
        }

        .token-info {
            background: #ecfdf5;
            border: 1px solid #10b981;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
        }

        .logs-container {
            background: #1f2937;
            color: #f9fafb;
            border-radius: 10px;
            padding: 20px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            max-height: 300px;
            overflow-y: auto;
            margin: 20px 0;
        }

        .log-entry {
            margin-bottom: 5px;
            padding: 3px 0;
        }

        .log-info { color: #60a5fa; }
        .log-success { color: #34d399; }
        .log-warning { color: #fbbf24; }
        .log-error { color: #f87171; }

        .status-steps {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .step-box {
            background: white;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border: 2px solid #e5e7eb;
        }

        .step-box.success {
            border-color: #10b981;
            background: #f0fdf4;
        }

        .step-number {
            display: inline-block;
            background: #10b981;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            text-align: center;
            line-height: 30px;
            font-weight: bold;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üéØ Teste Final</h1>
            <div class="success-badge">üîë NOVO TOKEN</div>
            <div class="success-badge">‚úÖ PERMISS√ïES ATIVAS</div>
            <div class="success-badge">üì± INSTAGRAM CONECTADO</div>
            <p>Token atualizado com todas as permiss√µes necess√°rias</p>
        </div>

        <!-- Token Info -->
        <div class="token-info">
            <strong>üîë Novo Token:</strong><br>
            EAAPHxlZBqFZAQBPCUMlAy4d8ucJ0LZB1l7JFJap9S6weioKntsZCEADCMSzqRxP60CGxo1ZBH0u1ZBFSjhiryJbBMWKIiYrnzufp9EtiywmoSk24ZBsdK17ePX1RBdHjBfYi6snqMGWnihrVHEWCW7E5qJ09hYhuhhjWUTZCOw54whUm2y1OD1vzQPXnGnxifKGPNkxhn1KrQjxF9ZBKpeUQ2Vs3ssw6wBvALsPeLNGd3AixxOfxocApY<br><br>
            <strong>‚úÖ Permiss√µes Ativas:</strong><br>
            ‚Ä¢ Mensagens e liga√ß√µes ‚úÖ<br>
            ‚Ä¢ Conte√∫do ‚úÖ<br>
            ‚Ä¢ Atividade da comunidade ‚úÖ<br>
            ‚Ä¢ Insights ‚úÖ<br>
            ‚Ä¢ Acesso parcial (Facebook e ferramentas) ‚úÖ
        </div>

        <!-- Status Steps -->
        <div class="status-steps">
            <div class="step-box success">
                <div class="step-number">1</div>
                <strong>Instagram Business</strong><br>
                <small>‚úÖ Conta profissional</small>
            </div>
            <div class="step-box success">
                <div class="step-number">2</div>
                <strong>P√°gina Conectada</strong><br>
                <small>‚úÖ "Teste instagram"</small>
            </div>
            <div class="step-box success">
                <div class="step-number">3</div>
                <strong>Permiss√µes</strong><br>
                <small>‚úÖ Todas ativas</small>
            </div>
            <div class="step-box">
                <div class="step-number">4</div>
                <strong>Webhook</strong><br>
                <small>‚è≥ Configurando...</small>
            </div>
        </div>

        <!-- Teste Final -->
        <div class="final-test">
            <h2 style="margin-bottom: 20px; color: #10b981;">üöÄ CONFIGURA√á√ÉO FINAL</h2>
            <p style="margin-bottom: 30px;">
                Agora com o token correto e todas as permiss√µes ativas, vamos configurar o webhook final!
            </p>

            <button class="btn" onclick="testNewToken()">
                üîë TESTAR NOVO TOKEN
            </button>

            <button class="btn btn-primary" onclick="configureWebhookFinal()" style="display: none;" id="webhook-btn">
                üì° CONFIGURAR WEBHOOK FINAL
            </button>

            <button class="btn btn-warning" onclick="testFullSystem()" style="display: none;" id="test-btn">
                üì± TESTAR SISTEMA COMPLETO
            </button>

            <div class="result-box" id="final-result" style="display: none;">
                Aguardando teste...
            </div>
        </div>

        <!-- Logs -->
        <div class="logs-container" id="logs-container">
            <div class="log-entry log-success">
                <span>[TOKEN]</span> Novo token gerado no Graph API Explorer
            </div>
            <div class="log-entry log-success">
                <span>[PERMISS√ïES]</span> Todas as permiss√µes ativadas no Meta Business Suite
            </div>
            <div class="log-entry log-info">
                <span>[SISTEMA]</span> Pronto para configura√ß√£o final do webhook
            </div>
        </div>
    </div>

    <script>
        // Novo token com permiss√µes completas
        const NEW_TOKEN = 'EAAPHxlZBqFZAQBPCUMlAy4d8ucJ0LZB1l7JFJap9S6weioKntsZCEADCMSzqRxP60CGxo1ZBH0u1ZBFSjhiryJbBMWKIiYrnzufp9EtiywmoSk24ZBsdK17ePX1RBdHjBfYi6snqMGWnihrVHEWCW7E5qJ09hYhuhhjWUTZCOw54whUm2y1OD1vzQPXnGnxifKGPNkxhn1KrQjxF9ZBKpeUQ2Vs3ssw6wBvALsPeLNGd3AixxOfxocApY';
        const PAGE_ID = '752860274568592'; // ID correto da p√°gina "Teste instagram"
        const BACKEND_URL = 'https://instagram-oauth-multione-production.up.railway.app';
        
        let pageToken = null;
        let testResults = {};

        // Testar novo token
        async function testNewToken() {
            addLog('info', 'üîë Testando novo token com permiss√µes...');
            showResult('üîë Verificando token...');
            
            try {
                // 1. Testar token b√°sico
                const meResponse = await fetch(`https://graph.facebook.com/v23.0/me?access_token=${NEW_TOKEN}`);
                const meData = await meResponse.json();
                
                if (meData.error) {
                    throw new Error(`Token inv√°lido: ${meData.error.message}`);
                }
                
                addLog('success', `‚úÖ Token v√°lido: ${meData.name}`);
                testResults.tokenValid = true;
                
                // 2. Obter p√°ginas
                const pagesResponse = await fetch(`https://graph.facebook.com/v23.0/me/accounts?access_token=${NEW_TOKEN}`);
                const pagesData = await pagesResponse.json();
                
                if (pagesData.error) {
                    throw new Error(`Erro ao obter p√°ginas: ${pagesData.error.message}`);
                }
                
                // 3. Encontrar p√°gina "Teste instagram"
                const targetPage = pagesData.data.find(page => page.id === PAGE_ID);
                
                if (!targetPage) {
                    throw new Error(`P√°gina ${PAGE_ID} n√£o encontrada`);
                }
                
                pageToken = targetPage.access_token;
                addLog('success', `‚úÖ P√°gina encontrada: ${targetPage.name}`);
                addLog('success', `üîë Page Token: ${pageToken.substring(0, 30)}...`);
                testResults.pageFound = true;
                
                // 4. Verificar Instagram conectado
                const igResponse = await fetch(`https://graph.facebook.com/v23.0/${PAGE_ID}?fields=instagram_business_account&access_token=${pageToken}`);
                const igData = await igResponse.json();
                
                if (igData.instagram_business_account) {
                    addLog('success', `‚úÖ Instagram conectado: ${igData.instagram_business_account.id}`);
                    testResults.instagramConnected = true;
                    
                    showResult(`üéâ TESTE COMPLETO - SUCESSO!
                    
‚úÖ Token v√°lido: ${meData.name}
‚úÖ P√°gina encontrada: ${targetPage.name}
‚úÖ Instagram conectado: ${igData.instagram_business_account.id}
üîë Page Token: ${pageToken.substring(0, 30)}...

üöÄ Pronto para configurar webhook!`);
                    
                    document.getElementById('webhook-btn').style.display = 'inline-block';
                    
                } else {
                    addLog('warning', '‚ö†Ô∏è Instagram n√£o conectado via API');
                    showResult(`‚ö†Ô∏è Instagram n√£o conectado via API
                    
‚úÖ Token v√°lido: ${meData.name}
‚úÖ P√°gina encontrada: ${targetPage.name}
‚ùå Instagram n√£o conectado via API Business

üí° Pode ser necess√°rio reconectar o Instagram √† p√°gina via Meta Business Suite.`);
                }
                
            } catch (error) {
                addLog('error', `‚ùå Erro: ${error.message}`);
                showResult(`‚ùå Teste falhou:
                
${error.message}

üí° Verifique:
- Token v√°lido no Graph API Explorer
- Permiss√µes corretas
- P√°gina conectada ao Instagram`);
            }
        }

        // Configurar webhook final
        async function configureWebhookFinal() {
            if (!pageToken) {
                addLog('warning', '‚ö†Ô∏è Execute primeiro o teste do token');
                return;
            }
            
            addLog('info', 'üì° Configurando webhook final...');
            showResult('üì° Configurando Page Subscription...');
            
            try {
                // 1. Ativar page subscription
                const subscriptionResponse = await fetch(`https://graph.facebook.com/v23.0/${PAGE_ID}/subscribed_apps`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `subscribed_fields=messages,messaging_postbacks,messaging_optins&access_token=${pageToken}`
                });
                
                const subscriptionData = await subscriptionResponse.json();
                
                if (subscriptionResponse.ok && subscriptionData.success) {
                    addLog('success', '‚úÖ Page Subscription ativada!');
                    
                    // 2. Verificar subscription
                    const verifyResponse = await fetch(`https://graph.facebook.com/v23.0/${PAGE_ID}/subscribed_apps?access_token=${pageToken}`);
                    const verifyData = await verifyResponse.json();
                    
                    if (verifyResponse.ok) {
                        // 3. Atualizar backend
                        await updateBackend();
                        
                        showResult(`üéâ WEBHOOK CONFIGURADO COM SUCESSO!
                        
‚úÖ Page Subscription: ATIVA
‚úÖ Backend: Configurado
‚úÖ Sistema: 100% FUNCIONANDO

üéØ TESTE FINAL:
Envie um DM para @wesley_costa322 no Instagram!
A mensagem DEVE aparecer no MultiOne agora!`);
                        
                        addLog('success', 'üéâ Sistema 100% configurado!');
                        document.getElementById('test-btn').style.display = 'inline-block';
                        
                    } else {
                        throw new Error('Falha na verifica√ß√£o da subscription');
                    }
                    
                } else {
                    throw new Error(`Falha na subscription: ${subscriptionData.error?.message || JSON.stringify(subscriptionData)}`);
                }
                
            } catch (error) {
                addLog('error', `‚ùå Erro: ${error.message}`);
                showResult(`‚ùå Falha na configura√ß√£o:
                
${error.message}

üí° Verifique se o token tem todas as permiss√µes necess√°rias.`);
            }
        }

        // Atualizar backend
        async function updateBackend() {
            try {
                addLog('info', 'üîÑ Atualizando backend...');
                
                const response = await fetch(`${BACKEND_URL}/api/setup-webhook`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        pageId: PAGE_ID,
                        pageAccessToken: pageToken,
                        userId: 'wesley_costa322'
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    addLog('success', '‚úÖ Backend configurado');
                } else {
                    addLog('warning', `‚ö†Ô∏è Backend: ${data.error}`);
                }
                
            } catch (error) {
                addLog('warning', `‚ö†Ô∏è Erro no backend: ${error.message}`);
            }
        }

        // Testar sistema completo
        async function testFullSystem() {
            addLog('info', 'üì± Testando sistema completo...');
            showResult('üì± Executando testes finais...');
            
            try {
                // 1. Testar backend
                const healthResponse = await fetch(`${BACKEND_URL}/health`);
                const healthData = await healthResponse.json();
                
                addLog('success', `‚úÖ Backend: ${healthData.status}`);
                
                // 2. Testar MultiOne
                const multioneResponse = await fetch(`${BACKEND_URL}/api/test/multione`, {
                    method: 'POST'
                });
                const multioneData = await multioneResponse.json();
                
                if (multioneData.success) {
                    addLog('success', '‚úÖ MultiOne funcionando');
                } else {
                    addLog('warning', `‚ö†Ô∏è MultiOne: ${multioneData.error}`);
                }
                
                // 3. Verificar webhook
                const webhookResponse = await fetch(`${BACKEND_URL}/webhook/instagram?hub.mode=subscribe&hub.verify_token=webhook_secret_123&hub.challenge=test123`);
                
                if (webhookResponse.ok) {
                    addLog('success', '‚úÖ Webhook endpoint funcionando');
                } else {
                    addLog('warning', '‚ö†Ô∏è Webhook endpoint com problema');
                }
                
                showResult(`üéâ SISTEMA COMPLETO FUNCIONANDO!
                
‚úÖ Backend: Online
‚úÖ MultiOne: Funcionando
‚úÖ Webhook: Ativo
‚úÖ Instagram: Conectado
‚úÖ Page Subscription: Ativa

üéØ TESTE FINAL:
Envie um DM para @wesley_costa322 no Instagram!
A mensagem deve aparecer no MultiOne!

üì± Teste agora: Envie "Ol√°" para @wesley_costa322`);
                
                addLog('success', 'üéâ Sistema 100% operacional!');
                addLog('info', 'üì± Envie DM para @wesley_costa322 para testar');
                
            } catch (error) {
                addLog('error', `‚ùå Erro no teste: ${error.message}`);
                showResult(`‚ùå Erro no teste do sistema:
                
${error.message}

üí° Alguns componentes podem estar offline.`);
            }
        }

        // Mostrar resultado
        function showResult(message) {
            const resultBox = document.getElementById('final-result');
            resultBox.style.display = 'block';
            resultBox.innerHTML = `<pre style="white-space: pre-wrap; margin: 0;">${message}</pre>`;
        }

        // Adicionar log
        function addLog(level, message) {
            const logsContainer = document.getElementById('logs-container');
            const timestamp = new Date().toLocaleTimeString();
            
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${level}`;
            logEntry.innerHTML = `<span>[${timestamp}]</span> ${message}`;
            
            logsContainer.insertBefore(logEntry, logsContainer.firstChild);
            
            while (logsContainer.children.length > 50) {
                logsContainer.removeChild(logsContainer.lastChild);
            }
        }

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            addLog('success', 'üéØ Sistema final carregado com novo token');
            addLog('success', '‚úÖ Permiss√µes ativas: Mensagens, Conte√∫do, Insights, etc.');
            addLog('info', 'üöÄ Pronto para configura√ß√£o final do webhook');
        });
    </script>
</body>
</html>
