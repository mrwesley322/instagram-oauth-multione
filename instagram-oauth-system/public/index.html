<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🔍 Debug Polling Instagram</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #ef4444, #dc2626, #b91c1c);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 25px;
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            border-radius: 15px;
        }

        .debug-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border-left: 5px solid #ef4444;
        }

        .btn {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin: 10px 0;
            font-size: 1rem;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(239, 68, 68, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .result-box {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            max-height: 400px;
            overflow-y: auto;
            border-left: 4px solid #ef4444;
            display: none;
        }

        .problem-box {
            background: #fef2f2;
            border: 2px solid #ef4444;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .solution-box {
            background: #ecfdf5;
            border: 2px solid #10b981;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🔍 Debug Polling Instagram</h1>
            <p>Identificando por que não encontra conversas</p>
        </div>

        <div class="problem-box">
            <h3 style="color: #ef4444; margin-bottom: 15px;">🚨 PROBLEMA IDENTIFICADO</h3>
            <p><strong>Status:</strong> "📭 [POLLING] Nenhuma conversa encontrada"</p>
            <p><strong>Causa:</strong> Instagram Business Account ID incorreto ou token sem permissões</p>
        </div>

        <div class="debug-section">
            <h3 style="color: #ef4444; margin-bottom: 15px;">1. 🔍 Verificar Token e Permissões</h3>
            <button class="btn" onclick="debugToken()">
                🔑 Debug Token Instagram
            </button>
            <div class="result-box" id="token-result">
                Aguardando verificação...
            </div>
        </div>

        <div class="debug-section">
            <h3 style="color: #ef4444; margin-bottom: 15px;">2. 📱 Encontrar Instagram Business Account ID Correto</h3>
            <button class="btn" onclick="findBusinessAccount()">
                📊 Buscar Business Account
            </button>
            <div class="result-box" id="account-result">
                Aguardando busca...
            </div>
        </div>

        <div class="debug-section">
            <h3 style="color: #ef4444; margin-bottom: 15px;">3. 💬 Testar API de Conversas</h3>
            <button class="btn" onclick="testConversationsAPI()">
                🧪 Testar Conversas API
            </button>
            <div class="result-box" id="conversations-result">
                Aguardando teste...
            </div>
        </div>

        <div class="debug-section">
            <h3 style="color: #ef4444; margin-bottom: 15px;">4. 🔄 Forçar Polling Manual</h3>
            <button class="btn btn-success" onclick="forcePoll()">
                ⚡ Polling Manual AGORA
            </button>
            <div class="result-box" id="poll-result">
                Aguardando polling...
            </div>
        </div>

        <div class="solution-box">
            <h3 style="color: #10b981; margin-bottom: 15px;">💡 SOLUÇÕES POSSÍVEIS</h3>
            <ol style="line-height: 1.8; margin-left: 20px;">
                <li><strong>Token Incorreto:</strong> Gerar novo token com permissões corretas</li>
                <li><strong>Business Account ID:</strong> Usar ID correto da conta Instagram Business</li>
                <li><strong>Permissões:</strong> Token precisa de instagram_basic + instagram_manage_messages</li>
                <li><strong>Conta Tipo:</strong> Precisa ser Instagram Business ou Creator Account</li>
            </ol>
        </div>
    </div>

    <script>
        const BACKEND_URL = 'https://instagram-oauth-multione-production.up.railway.app';

        // Debug do token
        async function debugToken() {
            updateResult('token-result', '🔑 Verificando token e permissões...');
            
            try {
                // Primeiro verificar se o token está funcionando
                const testUrl = 'https://graph.facebook.com/v18.0/me?access_token=EAAPHxlZBqFZAQBPMiCnZBvd54GWFFRm1ZCBtodu2mkCjEm0qnUzZAPfzj21pHZAAwX5gW3C92DEkZAPRq1OHx2B7QY8YFhZAoabuHCVnNniZBZB0XV6k6qQYJ4EqxCvioudZAWDzEdSozgnrzPYUozYa3RsUmaRsCsYWnsmCgLlRpcN9Gs9Of8ma8gYrUV5kGFHJbITY8dhD9yVcay4XoR5UUScVF3XApBiyZCqZBgc9qaAusOUQ4ZCzd3OfcToAZDZD&fields=id,name,accounts';
                
                const response = await fetch(testUrl);
                const data = await response.json();

                if (response.ok) {
                    let result = `🔑 TOKEN VÁLIDO:

📊 Usuário: ${data.name || 'N/A'}
🆔 ID: ${data.id || 'N/A'}

📱 PÁGINAS CONECTADAS:`;

                    if (data.accounts && data.accounts.data) {
                        data.accounts.data.forEach((page, index) => {
                            result += `\n${index + 1}. ${page.name} (ID: ${page.id})`;
                        });
                    } else {
                        result += '\n❌ Nenhuma página encontrada';
                    }

                    updateResult('token-result', result);
                } else {
                    updateResult('token-result', `❌ TOKEN INVÁLIDO:

Erro: ${data.error?.message || 'Token expirado ou inválido'}
Código: ${data.error?.code || response.status}

💡 SOLUÇÃO: Gerar novo token no Graph API Explorer`);
                }

            } catch (error) {
                updateResult('token-result', `❌ Erro ao verificar token: ${error.message}`);
            }
        }

        // Buscar Business Account correto
        async function findBusinessAccount() {
            updateResult('account-result', '📱 Buscando Instagram Business Account...');
            
            try {
                // Buscar páginas do usuário
                const pagesUrl = 'https://graph.facebook.com/v18.0/me/accounts?access_token=EAAPHxlZBqFZAQBPMiCnZBvd54GWFFRm1ZCBtodu2mkCjEm0qnUzZAPfzj21pHZAAwX5gW3C92DEkZAPRq1OHx2B7QY8YFhZAoabuHCVnNniZBZB0XV6k6qQYJ4EqxCvioudZAWDzEdSozgnrzPYUozYa3RsUmaRsCsYWnsmCgLlRpcN9Gs9Of8ma8gYrUV5kGFHJbITY8dhD9yVcay4XoR5UUScVF3XApBiyZCqZBgc9qaAusOUQ4ZCzd3OfcToAZDZD';
                
                const pagesResponse = await fetch(pagesUrl);
                const pagesData = await pagesResponse.json();

                if (!pagesResponse.ok) {
                    updateResult('account-result', `❌ Erro ao buscar páginas: ${pagesData.error?.message}`);
                    return;
                }

                let result = `📱 PÁGINAS ENCONTRADAS:\n\n`;

                if (pagesData.data && pagesData.data.length > 0) {
                    for (let i = 0; i < pagesData.data.length; i++) {
                        const page = pagesData.data[i];
                        result += `${i + 1}. 📄 ${page.name}\n`;
                        result += `   🆔 Page ID: ${page.id}\n`;

                        // Verificar se tem Instagram conectado
                        try {
                            const igUrl = `https://graph.facebook.com/v18.0/${page.id}?access_token=${page.access_token}&fields=instagram_business_account`;
                            const igResponse = await fetch(igUrl);
                            const igData = await igResponse.json();

                            if (igData.instagram_business_account) {
                                result += `   ✅ Instagram: ${igData.instagram_business_account.id}\n`;
                                result += `   📸 ESTE É O ID CORRETO! ^^^^^^^^^\n`;
                            } else {
                                result += `   ❌ Instagram: Não conectado\n`;
                            }
                        } catch (error) {
                            result += `   ⚠️ Instagram: Erro ao verificar\n`;
                        }
                        result += `\n`;
                    }
                } else {
                    result += `❌ Nenhuma página encontrada\n\n`;
                }

                result += `💡 ATUAL NO SISTEMA: 17841400008460056\n`;
                result += `🔍 VERIFIQUE: Se o ID acima é diferente, atualize no código!`;

                updateResult('account-result', result);

            } catch (error) {
                updateResult('account-result', `❌ Erro ao buscar Business Account: ${error.message}`);
            }
        }

        // Testar API de conversas
        async function testConversationsAPI() {
            updateResult('conversations-result', '💬 Testando API de conversas...');
            
            try {
                // Testar com diferentes IDs
                const idsToTest = [
                    '17841400008460056', // ID atual
                    '752860274568592'    // ID da página
                ];

                let result = `💬 TESTANDO API DE CONVERSAS:\n\n`;

                for (const id of idsToTest) {
                    result += `🔍 Testando ID: ${id}\n`;
                    
                    try {
                        const conversationsUrl = `https://graph.facebook.com/v18.0/${id}/conversations?access_token=EAAPHxlZBqFZAQBPMiCnZBvd54GWFFRm1ZCBtodu2mkCjEm0qnUzZAPfzj21pHZAAwX5gW3C92DEkZAPRq1OHx2B7QY8YFhZAoabuHCVnNniZBZB0XV6k6qQYJ4EqxCvioudZAWDzEdSozgnrzPYUozYa3RsUmaRsCsYWnsmCgLlRpcN9Gs9Of8ma8gYrUV5kGFHJbITY8dhD9yVcay4XoR5UUScVF3XApBiyZCqZBgc9qaAusOUQ4ZCzd3OfcToAZDZD&fields=id,updated_time,participants`;
                        
                        const response = await fetch(conversationsUrl);
                        const data = await response.json();

                        if (response.ok && data.data) {
                            result += `✅ FUNCIONOU! ${data.data.length} conversas encontradas\n`;
                            if (data.data.length > 0) {
                                result += `📊 Primeira conversa: ${data.data[0].id}\n`;
                                result += `⏰ Atualizada: ${data.data[0].updated_time}\n`;
                            }
                            result += `🎯 USE ESTE ID: ${id}\n`;
                        } else {
                            result += `❌ Erro: ${data.error?.message || 'Sem conversas'}\n`;
                        }
                    } catch (error) {
                        result += `❌ Erro: ${error.message}\n`;
                    }
                    result += `\n`;
                }

                updateResult('conversations-result', result);

            } catch (error) {
                updateResult('conversations-result', `❌ Erro no teste: ${error.message}`);
            }
        }

        // Forçar polling manual
        async function forcePoll() {
            updateResult('poll-result', '⚡ Forçando polling manual...');
            
            try {
                const response = await fetch(`${BACKEND_URL}/api/polling/control`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ action: 'poll_now' })
                });

                const data = await response.json();

                if (data.success) {
                    updateResult('poll-result', `✅ Polling executado: ${data.message}\n\nAgora verifique os logs em:\n${BACKEND_URL}/api/logs`);
                } else {
                    updateResult('poll-result', `❌ Erro no polling: ${data.error}`);
                }

            } catch (error) {
                updateResult('poll-result', `❌ Erro ao forçar polling: ${error.message}`);
            }
        }

        // Utilitário
        function updateResult(elementId, message) {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            element.innerHTML = `<pre style="white-space: pre-wrap; margin: 0; font-size: 0.85rem;">${message}</pre>`;
        }
    </script>
</body>
</html>
