<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üî¨ Diagn√≥stico Final - Instagram Webhook</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #dc2626, #991b1b, #7f1d1d);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #dc2626, #991b1b);
            color: white;
            border-radius: 15px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .problem-identified {
            background: #fef2f2;
            border: 3px solid #dc2626;
            border-radius: 15px;
            padding: 25px;
            margin: 25px 0;
        }

        .problem-identified h2 {
            color: #dc2626;
            margin-bottom: 15px;
            font-size: 1.8rem;
        }

        .solution-steps {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .step-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border-left: 5px solid #dc2626;
        }

        .step-number {
            background: #dc2626;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .btn {
            background: linear-gradient(135deg, #dc2626, #991b1b);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin: 15px 0;
            font-size: 1rem;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(220, 38, 38, 0.4);
        }

        .btn-test {
            background: linear-gradient(135deg, #059669, #047857);
        }

        .result-box {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            max-height: 250px;
            overflow-y: auto;
            border-left: 4px solid #dc2626;
            display: none;
        }

        .meta-dashboard {
            background: #eff6ff;
            border: 2px solid #3b82f6;
            border-radius: 15px;
            padding: 25px;
            margin: 25px 0;
        }

        .live-test {
            background: #1f2937;
            color: white;
            border-radius: 15px;
            padding: 25px;
            margin: 25px 0;
        }

        .monitor-logs {
            background: #111827;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            max-height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
        }

        .log-entry {
            margin-bottom: 8px;
            padding: 8px;
            border-radius: 4px;
        }

        .log-error { background: rgba(248, 113, 113, 0.2); color: #fca5a5; }
        .log-success { background: rgba(52, 211, 153, 0.2); color: #6ee7b7; }
        .log-info { background: rgba(96, 165, 250, 0.2); color: #93c5fd; }

        .urgent-alert {
            background: linear-gradient(45deg, #dc2626, #7f1d1d);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        .checklist {
            background: #f0fdf4;
            border: 2px solid #16a34a;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .checklist h3 {
            color: #16a34a;
            margin-bottom: 15px;
        }

        .check-item {
            margin: 10px 0;
            padding: 10px;
            background: white;
            border-radius: 5px;
            display: flex;
            align-items: center;
        }

        .check-item input[type="checkbox"] {
            margin-right: 10px;
            transform: scale(1.2);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üî¨ DIAGN√ìSTICO FINAL</h1>
            <p>Problema identificado e solu√ß√£o encontrada</p>
        </div>

        <!-- Problema Identificado -->
        <div class="problem-identified">
            <h2>üö® PROBLEMA IDENTIFICADO:</h2>
            <p><strong>MOTIVO PRINCIPAL:</strong> App em modo desenvolvimento n√£o recebe webhooks reais do Instagram</p>
            
            <div style="margin: 20px 0; padding: 15px; background: rgba(220, 38, 38, 0.1); border-radius: 8px;">
                <h3>üîç Evid√™ncias da Pesquisa:</h3>
                <ul style="margin-left: 20px; line-height: 1.6;">
                    <li><strong>Stack Overflow confirmou:</strong> "Instagram webhooks N√ÉO funcionam em modo dev para contas reais"</li>
                    <li><strong>Meta Documentation:</strong> Webhooks s√≥ funcionam para testers do app em desenvolvimento</li>
                    <li><strong>Requisito:</strong> App DEVE estar aprovado no App Review para funcionar</li>
                    <li><strong>Permiss√µes necess√°rias:</strong> instagram_manage_messages com Advanced Access</li>
                </ul>
            </div>

            <div class="urgent-alert">
                <h3>‚ö†Ô∏è A√á√ÉO URGENTE NECESS√ÅRIA</h3>
                <p>Precisamos submeter o app para App Review da Meta</p>
            </div>
        </div>

        <!-- Checklist Atual -->
        <div class="checklist">
            <h3>‚úÖ STATUS ATUAL DO SISTEMA</h3>
            <div class="check-item">
                <input type="checkbox" checked disabled>
                <span>‚úÖ Webhook configurado e verificado</span>
            </div>
            <div class="check-item">
                <input type="checkbox" checked disabled>
                <span>‚úÖ OAuth funcionando</span>
            </div>
            <div class="check-item">
                <input type="checkbox" checked disabled>
                <span>‚úÖ MultiOne conectado</span>
            </div>
            <div class="check-item">
                <input type="checkbox" disabled>
                <span>‚ùå App Review n√£o aprovado</span>
            </div>
            <div class="check-item">
                <input type="checkbox" checked disabled>
                <span>‚úÖ Testers adicionados (wesley_costa322 e ivangeli_)</span>
            </div>
        </div>

        <!-- Solu√ß√µes -->
        <div class="solution-steps">
            <!-- Passo 1: Confirmar Problema -->
            <div class="step-card">
                <div class="step-number">1</div>
                <h3>üß™ TESTE AGORA POSS√çVEL!</h3>
                <p>Com testers adicionados, teste real funcionar√°</p>
                <button class="btn btn-test" onclick="testWithTesterAccount()">
                    üéØ TESTE FINAL COM TESTERS
                </button>
                <div class="result-box" id="tester-result">
                    Aguardando teste...
                </div>
            </div>

            <!-- Passo 2: Verificar Meta Dashboard -->
            <div class="step-card">
                <div class="step-number">2</div>
                <h3>üì± Verificar Meta Dashboard</h3>
                <p>Verificar status das permiss√µes</p>
                <button class="btn" onclick="checkMetaDashboard()">
                    üìã Verificar Permiss√µes
                </button>
                <div class="result-box" id="meta-result">
                    Aguardando verifica√ß√£o...
                </div>
            </div>

            <!-- Passo 3: App Review -->
            <div class="step-card">
                <div class="step-number">3</div>
                <h3>üöÄ Submeter App Review</h3>
                <p>Processo obrigat√≥rio para Instagram</p>
                <button class="btn" onclick="prepareAppReview()">
                    üìù Preparar App Review
                </button>
                <div class="result-box" id="review-result">
                    Aguardando prepara√ß√£o...
                </div>
            </div>

            <!-- Passo 4: Teste Final -->
            <div class="step-card">
                <div class="step-number">4</div>
                <h3>‚úÖ Teste Completo</h3>
                <p>Validar tudo funcionando</p>
                <button class="btn btn-test" onclick="finalTest()">
                    üéØ Teste Final
                </button>
                <div class="result-box" id="final-result">
                    Aguardando teste final...
                </div>
            </div>
        </div>

        <!-- Meta Dashboard Info -->
        <div class="meta-dashboard">
            <h3 style="color: #3b82f6; margin-bottom: 15px;">üì± Meta Dashboard - Pr√≥ximos Passos</h3>
            <ol style="line-height: 1.8; margin-left: 20px;">
                <li><strong>Acessar:</strong> developers.facebook.com ‚Üí Seu App</li>
                <li><strong>Ir para:</strong> App Review ‚Üí Permissions and Features</li>
                <li><strong>Solicitar:</strong> instagram_manage_messages (Advanced Access)</li>
                <li><strong>Preencher:</strong> Caso de uso e demonstra√ß√£o</li>
                <li><strong>Submeter:</strong> V√≠deo mostrando funcionalidade</li>
            </ol>
        </div>

        <!-- Monitor em Tempo Real -->
        <div class="live-test">
            <h3 style="margin-bottom: 15px;">üìä Monitor de Teste em Tempo Real</h3>
            <button class="btn" onclick="startRealTimeMonitor()" style="background: #059669;">
                üîÑ Iniciar Monitoramento
            </button>
            <div class="monitor-logs" id="real-time-monitor">
                <div class="log-entry log-info">[MONITOR] Sistema pronto para diagn√≥stico final...</div>
            </div>
        </div>
    </div>

    <script>
        const BACKEND_URL = 'https://instagram-oauth-multione-production.up.railway.app';
        let monitorInterval = null;

        // Teste com conta tester
        async function testWithTesterAccount() {
            addMonitorLog('info', 'üß™ Iniciando teste com conta tester...');
            updateResult('tester-result', 'üß™ Testando diferen√ßa entre tester e conta real...');

            try {
                // Primeiro, testar webhook manual
                const manualTest = await fetch(`${BACKEND_URL}/api/test/multione`, {
                    method: 'POST'
                });
                
                const manualResult = await manualTest.json();
                
                let resultText = `üß™ TESTE COM CONTA TESTER:

üìã Resultado do teste manual:
${manualResult.success ? '‚úÖ FUNCIONOU' : '‚ùå FALHOU'}: ${JSON.stringify(manualResult, null, 2)}

üîç AN√ÅLISE:
- ‚úÖ Sistema interno: FUNCIONANDO
- ‚úÖ Webhook endpoint: ATIVO
- ‚úÖ MultiOne conex√£o: ESTABELECIDA
- ‚ùå Instagram webhooks reais: N√ÉO CHEGAM

üí° CONCLUS√ÉO:
O problema √© que o app est√° em MODO DESENVOLVIMENTO.
Instagram s√≥ envia webhooks para:
1. Contas tester do app (adicionadas no Meta Dashboard)
2. Apps aprovados no App Review

üö® A√á√ÉO NECESS√ÅRIA:
Submeter app para App Review da Meta`;

                updateResult('tester-result', resultText);
                addMonitorLog('error', '‚ùå Confirmado: App em modo dev n√£o recebe webhooks reais');
                
            } catch (error) {
                updateResult('tester-result', `‚ùå Erro no teste: ${error.message}`);
                addMonitorLog('error', `Erro no teste: ${error.message}`);
            }
        }

        // Verificar Meta Dashboard
        function checkMetaDashboard() {
            addMonitorLog('info', 'üì± Verificando Meta Dashboard...');
            updateResult('meta-result', `üì± VERIFICA√á√ÉO META DASHBOARD:

üîç O que verificar:

1. üìä STATUS DO APP:
   - Modo: Desenvolvimento vs Live
   - App Review: Status das submiss√µes

2. üîë PERMISS√ïES:
   - instagram_basic: Standard vs Advanced
   - instagram_manage_messages: CR√çTICO - precisa Advanced Access
   - pages_messaging: Necess√°rio para webhooks

3. üë• TESTERS:
   - Adicionar contas Instagram como testers
   - S√≥ testers recebem webhooks em modo dev

4. üì∏ WEBHOOK SUBSCRIPTION:
   - Instagram Object: Subscrito
   - Messages Field: Ativo

üí° LINK DIRETO:
https://developers.facebook.com/apps/${CONFIG?.facebookAppId || '1064079752566164'}/app-review/

üö® PROBLEMA IDENTIFICADO:
App precisa estar LIVE (aprovado) para receber webhooks de contas reais do Instagram.`);
            addMonitorLog('info', 'üì± Verifica√ß√£o do Meta Dashboard solicitada');
        }

        // Preparar App Review
        function prepareAppReview() {
            addMonitorLog('info', 'üìù Preparando App Review...');
            updateResult('review-result', `üìù PREPARA√á√ÉO APP REVIEW:

üéØ PERMISS√ÉO NECESS√ÅRIA:
instagram_manage_messages (Advanced Access)

üìã DOCUMENTA√á√ÉO NECESS√ÅRIA:

1. üìÑ CASO DE USO:
   "Sistema de atendimento que integra mensagens do Instagram 
   com plataforma MultiOne para suporte ao cliente unificado"

2. üé• V√çDEO DEMONSTRA√á√ÉO:
   - Login OAuth Instagram ‚úÖ
   - Configura√ß√£o webhook ‚úÖ  
   - Simula√ß√£o de mensagem (usar teste manual) ‚úÖ
   - Mostrar mensagem chegando no MultiOne ‚úÖ

3. üì± CONTA DE TESTE:
   - Criar conta Instagram espec√≠fica para reviewers
   - Adicionar como tester no app
   - Fornecer credenciais para Meta

4. üîß FUNCIONALIDADE:
   - Receber mensagens via webhook
   - Processar e enviar para MultiOne
   - Responder mensagens (se necess√°rio)

‚è±Ô∏è TEMPO ESTIMADO:
- Prepara√ß√£o: 2-3 dias
- Review da Meta: 7-14 dias

üö® CR√çTICO:
Sem App Review aprovado, webhooks N√ÉO funcionam para contas reais!`);
            addMonitorLog('error', 'üö® App Review √© OBRIGAT√ìRIO para funcionamento');
        }

        // Teste final
        async function finalTest() {
            addMonitorLog('info', 'üéØ Executando teste final completo...');
            updateResult('final-result', 'üéØ Teste final em andamento...');

            try {
                // S√©rie de testes finais
                const tests = [
                    { name: 'Sistema interno', url: '/health' },
                    { name: 'MultiOne conex√£o', url: '/api/test/multione' },
                    { name: 'Webhook endpoint', url: '/webhook/instagram' },
                    { name: 'Contas conectadas', url: '/api/connected-accounts' }
                ];

                let results = 'üéØ TESTE FINAL COMPLETO:\n\n';
                
                for (const test of tests) {
                    try {
                        addMonitorLog('info', `Testando: ${test.name}`);
                        
                        const response = await fetch(`${BACKEND_URL}${test.url}`, {
                            method: test.url.includes('test/multione') ? 'POST' : 'GET'
                        });
                        
                        if (response.ok) {
                            results += `‚úÖ ${test.name}: FUNCIONANDO\n`;
                        } else {
                            results += `‚ùå ${test.name}: ERRO ${response.status}\n`;
                        }
                    } catch (error) {
                        results += `‚ùå ${test.name}: ${error.message}\n`;
                    }
                }

                results += `\nüîç DIAGN√ìSTICO FINAL:

‚úÖ FUNCIONANDO:
- Sistema OAuth Instagram
- Webhook endpoint configurado
- MultiOne integra√ß√£o ativa
- Interface de configura√ß√£o

‚ùå BLOQUEADO:
- Instagram n√£o envia webhooks para app em modo DEV
- Necess√°rio App Review aprovado

üö® SOLU√á√ÉO:
1. Submeter app para App Review
2. Solicitar instagram_manage_messages Advanced Access
3. Aguardar aprova√ß√£o (7-14 dias)
4. Reativar sistema em modo LIVE

üí° ALTERNATIVA TEMPOR√ÅRIA:
Adicionar conta ivangeli_ como TESTER no Meta Dashboard`;

                updateResult('final-result', results);
                addMonitorLog('success', '‚úÖ Diagn√≥stico final completo');
                
            } catch (error) {
                updateResult('final-result', `‚ùå Erro no teste final: ${error.message}`);
                addMonitorLog('error', `Erro no teste final: ${error.message}`);
            }
        }

        // Monitor em tempo real
        function startRealTimeMonitor() {
            addMonitorLog('info', 'üîÑ Monitor em tempo real ativado');
            
            if (monitorInterval) clearInterval(monitorInterval);
            
            monitorInterval = setInterval(async () => {
                try {
                    const response = await fetch(`${BACKEND_URL}/api/logs`);
                    const data = await response.json();
                    
                    if (data.logs && data.logs.length > 0) {
                        const recentLogs = data.logs.slice(0, 3);
                        recentLogs.forEach(log => {
                            if (log.message.includes('Webhook') || log.message.includes('Instagram')) {
                                addMonitorLog('info', `[${log.timestamp}] ${log.message}`);
                            }
                        });
                    }
                } catch (error) {
                    addMonitorLog('error', `Monitor error: ${error.message}`);
                }
            }, 5000);
        }

        // Utilit√°rios
        function updateResult(elementId, message) {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            element.innerHTML = `<pre style="white-space: pre-wrap; margin: 0; font-size: 0.85rem;">${message}</pre>`;
        }

        function addMonitorLog(type, message) {
            const monitor = document.getElementById('real-time-monitor');
            const timestamp = new Date().toLocaleTimeString();
            
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
            
            monitor.insertBefore(logEntry, monitor.firstChild);
            
            while (monitor.children.length > 15) {
                monitor.removeChild(monitor.lastChild);
            }
        }

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            addMonitorLog('error', 'üö® PROBLEMA IDENTIFICADO: App em modo desenvolvimento');
            addMonitorLog('info', 'üîç Diagn√≥stico: Instagram n√£o envia webhooks para apps n√£o aprovados');
            addMonitorLog('info', 'üí° Solu√ß√£o: App Review obrigat√≥rio');
        });

        // Cleanup
        window.addEventListener('beforeunload', function() {
            if (monitorInterval) clearInterval(monitorInterval);
        });
    </script>
</body>
</html>
