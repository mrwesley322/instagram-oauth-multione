<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üî¨ Teste Final Definitivo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #7c3aed, #5b21b6, #4c1d95);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            background: linear-gradient(135deg, #7c3aed, #5b21b6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .final-badge {
            background: linear-gradient(135deg, #7c3aed, #5b21b6);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            display: inline-block;
            margin: 5px;
        }

        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .test-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border: 2px solid #e5e7eb;
        }

        .test-card.critical {
            border-color: #ef4444;
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.05), rgba(255, 255, 255, 1));
        }

        .btn {
            background: linear-gradient(135deg, #7c3aed, #5b21b6);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin: 10px 0;
            font-size: 1rem;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(124, 58, 237, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .result-box {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
            max-height: 200px;
            overflow-y: auto;
            border-left: 4px solid #7c3aed;
        }

        .critical-info {
            background: #fef2f2;
            border: 2px solid #ef4444;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .webhook-test {
            background: #f0f9ff;
            border: 2px solid #3b82f6;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }

        .live-monitor {
            background: #1f2937;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            min-height: 300px;
        }

        .monitor-logs {
            color: #f9fafb;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            max-height: 250px;
            overflow-y: auto;
        }

        .log-entry {
            margin-bottom: 5px;
            padding: 5px;
            border-radius: 3px;
        }

        .log-webhook { background: rgba(167, 139, 250, 0.2); color: #c4b5fd; }
        .log-success { background: rgba(52, 211, 153, 0.2); color: #6ee7b7; }
        .log-error { background: rgba(248, 113, 113, 0.2); color: #fca5a5; }
        .log-info { background: rgba(96, 165, 250, 0.2); color: #93c5fd; }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üî¨ Teste Final Definitivo</h1>
            <div class="final-badge">üö® MENSAGEM N√ÉO SUBIU</div>
            <div class="final-badge">üî¨ DIAGN√ìSTICO FINAL</div>
            <p>√öltima verifica√ß√£o - vamos identificar o problema exato</p>
        </div>

        <!-- Problema Cr√≠tico -->
        <div class="critical-info">
            <h3 style="color: #ef4444; margin-bottom: 15px;">üö® DISCREP√ÇNCIA IDENTIFICADA:</h3>
            <p><strong>Sistema configurado:</strong> sock.multi360.digital</p>
            <p><strong>Painel real:</strong> painel.multione.digital</p>
            <p><strong>Suspeita:</strong> URL do MultiOne pode estar incorreta!</p>
        </div>

        <!-- Testes Cr√≠ticos Finais -->
        <div class="test-grid">
            <!-- 1. Teste URLs MultiOne -->
            <div class="test-card critical">
                <h3 style="color: #ef4444; margin-bottom: 15px;">1. üåê URLs MultiOne</h3>
                <button class="btn btn-danger" onclick="testMultiOneUrls()">
                    üîç Testar URLs MultiOne
                </button>
                <div class="result-box" id="url-result" style="display: none;">
                    Aguardando teste...
                </div>
            </div>

            <!-- 2. Webhook Real Time -->
            <div class="test-card critical">
                <h3 style="color: #ef4444; margin-bottom: 15px;">2. üì° Webhook Tempo Real</h3>
                <button class="btn" onclick="startRealTimeMonitor()">
                    üì° Monitor Tempo Real
                </button>
                <div class="result-box" id="webhook-monitor" style="display: none;">
                    Aguardando ativa√ß√£o...
                </div>
            </div>

            <!-- 3. Envio Manual -->
            <div class="test-card">
                <h3 style="margin-bottom: 15px;">3. üß™ Envio Manual</h3>
                <button class="btn btn-success" onclick="sendManualMessage()">
                    üì® Enviar Mensagem Manual
                </button>
                <div class="result-box" id="manual-result" style="display: none;">
                    Aguardando envio...
                </div>
            </div>

            <!-- 4. Webhook Direto -->
            <div class="test-card">
                <h3 style="margin-bottom: 15px;">4. üéØ Webhook Direto</h3>
                <button class="btn" onclick="triggerWebhookDirect()">
                    üéØ Acionar Webhook Direto
                </button>
                <div class="result-box" id="direct-result" style="display: none;">
                    Aguardando a√ß√£o...
                </div>
            </div>
        </div>

        <!-- Teste de Webhook em Tempo Real -->
        <div class="webhook-test">
            <h3 style="color: #3b82f6; margin-bottom: 15px;">üì± TESTE EM TEMPO REAL</h3>
            <p style="margin-bottom: 20px;">
                <strong>AGORA:</strong> Envie DM de ivangeli_ para wesley_costa322<br>
                <strong>TEXTO:</strong> "TESTE FINAL DEFINITIVO"<br>
                <strong>MONITORAMENTO:</strong> Ativo abaixo
            </p>
            <button class="btn" onclick="startFullMonitoring()">
                üîÑ INICIAR MONITORAMENTO COMPLETO
            </button>
        </div>

        <!-- Monitor em Tempo Real -->
        <div class="live-monitor">
            <h3 style="color: #f9fafb; margin-bottom: 15px;">üìä Monitor em Tempo Real</h3>
            <div class="monitor-logs" id="live-monitor">
                <div class="log-entry log-info">[MONITOR] Sistema carregado - aguardando teste...</div>
            </div>
        </div>
    </div>

    <script>
        const BACKEND_URL = 'https://instagram-oauth-multione-production.up.railway.app';
        
        // URLs poss√≠veis do MultiOne
        const MULTIONE_URLS = [
            'https://sock.multi360.digital/api/messages/send',
            'https://painel.multione.digital/api/messages/send',
            'https://api.multione.digital/messages/send',
            'https://multione.digital/api/messages/send'
        ];

        let monitoringActive = false;
        let monitorInterval = null;

        // Testar URLs do MultiOne
        async function testMultiOneUrls() {
            addLog('info', 'üåê Testando diferentes URLs do MultiOne...');
            updateResult('url-result', 'üåê Testando URLs...');
            
            const results = [];
            
            for (const url of MULTIONE_URLS) {
                try {
                    addLog('info', `üîç Testando: ${url}`);
                    
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer 68eff5505a3989e99dadbc7243c9411efba9a80ef1f59e4680c89678bf63f515'
                        },
                        body: JSON.stringify({
                            number: 'test_final',
                            message: 'Teste URL MultiOne',
                            sender_id: 'test_url',
                            sender_name: 'Teste URL',
                            platform: 'instagram',
                            timestamp: new Date().toISOString(),
                            type: 'inbound'
                        })
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        results.push(`‚úÖ ${url}: FUNCIONOU!`);
                        addLog('success', `‚úÖ URL funcionou: ${url}`);
                    } else {
                        results.push(`‚ùå ${url}: ${response.status}`);
                        addLog('error', `‚ùå ${url}: Status ${response.status}`);
                    }
                    
                } catch (error) {
                    results.push(`‚ùå ${url}: ${error.message}`);
                    addLog('error', `‚ùå ${url}: ${error.message}`);
                }
            }
            
            updateResult('url-result', `üåê Resultados dos testes:

${results.join('\n')}

üí° Se alguma URL funcionou, essa √© a correta!`);
        }

        // Monitor em tempo real
        async function startRealTimeMonitor() {
            addLog('info', 'üì° Iniciando monitor de webhook...');
            updateResult('webhook-monitor', 'üì° Monitorando webhooks...');
            
            monitoringActive = true;
            monitorInterval = setInterval(async () => {
                try {
                    const response = await fetch(`${BACKEND_URL}/api/logs`);
                    const data = await response.json();
                    
                    if (data.logs) {
                        const webhookLogs = data.logs.filter(log => 
                            log.message.includes('Webhook') || 
                            log.message.includes('mensagem') ||
                            log.message.includes('Instagram') ||
                            log.message.includes('MultiOne')
                        ).slice(0, 5);
                        
                        if (webhookLogs.length > 0) {
                            updateResult('webhook-monitor', `üì° Atividade detectada:

${webhookLogs.map(log => `[${log.timestamp}] ${log.message}`).join('\n')}

${webhookLogs.length > 5 ? '...' : ''}`);
                        }
                    }
                } catch (error) {
                    addLog('error', `Erro no monitor: ${error.message}`);
                }
            }, 3000);
        }

        // Envio manual
        async function sendManualMessage() {
            addLog('info', 'üì® Enviando mensagem manual...');
            updateResult('manual-result', 'üì® Enviando...');
            
            try {
                const response = await fetch(`${BACKEND_URL}/api/test/multione`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    updateResult('manual-result', `‚úÖ Mensagem enviada!

üì® Resposta: ${JSON.stringify(data.result, null, 2)}

üí° Se isso funcionou, o problema √© que o Instagram n√£o est√° enviando webhooks.`);
                    addLog('success', '‚úÖ Envio manual funcionou');
                } else {
                    updateResult('manual-result', `‚ùå Falha no envio:

${data.error}

üí° Problema na conex√£o com MultiOne.`);
                    addLog('error', `‚ùå Envio manual falhou: ${data.error}`);
                }
                
            } catch (error) {
                updateResult('manual-result', `‚ùå Erro:

${error.message}`);
                addLog('error', `‚ùå Erro no envio: ${error.message}`);
            }
        }

        // Webhook direto
        async function triggerWebhookDirect() {
            addLog('info', 'üéØ Acionando webhook direto...');
            updateResult('direct-result', 'üéØ Enviando webhook...');
            
            try {
                const response = await fetch(`${BACKEND_URL}/webhook/instagram`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        object: 'instagram',
                        entry: [{
                            id: '752860274568592',
                            messaging: [{
                                sender: { id: 'debug_final' },
                                recipient: { id: '752860274568592' },
                                timestamp: Date.now(),
                                message: {
                                    mid: 'debug_final_' + Date.now(),
                                    text: 'TESTE FINAL DEFINITIVO'
                                }
                            }]
                        }]
                    })
                });
                
                if (response.ok) {
                    const result = await response.text();
                    updateResult('direct-result', `‚úÖ Webhook acionado!

üì° Status: ${response.status}
üìù Resposta: ${result}

üí° Se isso processar mensagem, o webhook funciona internamente.`);
                    addLog('webhook', 'üéØ Webhook direto acionado');
                } else {
                    updateResult('direct-result', `‚ùå Webhook falhou:

üì° Status: ${response.status}`);
                    addLog('error', `‚ùå Webhook direto falhou: ${response.status}`);
                }
                
            } catch (error) {
                updateResult('direct-result', `‚ùå Erro:

${error.message}`);
                addLog('error', `‚ùå Erro webhook direto: ${error.message}`);
            }
        }

        // Monitoramento completo
        async function startFullMonitoring() {
            addLog('info', 'üîÑ Iniciando monitoramento completo...');
            
            await testMultiOneUrls();
            await startRealTimeMonitor();
            await sendManualMessage();
            await triggerWebhookDirect();
            
            addLog('success', 'üéâ Monitoramento completo ativo');
            addLog('info', 'üì± AGORA: Envie DM de ivangeli_ para wesley_costa322');
        }

        // Utilit√°rios
        function updateResult(elementId, message) {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            element.innerHTML = `<pre style="white-space: pre-wrap; margin: 0; font-size: 0.8rem;">${message}</pre>`;
        }

        function addLog(type, message) {
            const monitor = document.getElementById('live-monitor');
            const timestamp = new Date().toLocaleTimeString();
            
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
            
            monitor.insertBefore(logEntry, monitor.firstChild);
            
            while (monitor.children.length > 20) {
                monitor.removeChild(monitor.lastChild);
            }
        }

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            addLog('info', 'üî¨ Teste final definitivo carregado');
            addLog('error', 'üö® Mensagem n√£o subiu - investigando...');
        });

        // Cleanup
        window.addEventListener('beforeunload', function() {
            if (monitorInterval) clearInterval(monitorInterval);
        });
    </script>
</body>
</html>
